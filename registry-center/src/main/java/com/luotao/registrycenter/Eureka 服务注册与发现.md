# Eureka 服务注册与发现

Eureka 是 Netflix 开源的一款基于 REST 的服务治理组件，主要用于实现 AWS 云环境中的服务发现。在现代的微服务架构中，我们通常会将一个大型应用拆分成多个小而独立的服务。这些服务实例的网络地址（IP和端口）可能会因为动态扩缩容、故障转移等原因而频繁变化。

Eureka 就充当了一个“服务注册中心”的角色。它允许各个微服务（即 Eureka Client）在启动时向 Eureka Server 注册自己的网络位置等信息。当一个服务需要调用另一个服务时，它可以向 Eureka Server 查询目标服务当前可用的实例列表，然后进行调用。

简单来说，Eureka 就像是微服务世界里的一个动态更新的“电话簿”或“地址簿”，帮助服务之间相互定位和通信。

> *   Eureka Server 可以通过运行多个实例并相互注册（Peer-to-Peer）来构建高可用集群。任何一个 Server 节点宕机，其他节点仍然可以提供服务注册与发现功能。
> *   Eureka Client 会缓存服务注册信息在本地。即使所有 Eureka Server 都宕机，客户端仍然可以利用本地缓存信息来发现和调用服务（尽管这些信息可能不是最新的），这在一定程度上保证了系统的韧性。

---

为了更形象地理解 Eureka，我们可以把它比作一个大型连锁商场的导购系统。

*   **商场总部（Eureka Server 集群）**：负责维护所有店铺的最新信息。
*   **各个店铺（微服务实例/服务提供者）**：
    *   开业时（服务启动），店铺会去总部登记自己的位置、经营范围等信息（服务注册）。
    *   营业期间（服务运行），店铺会定期向总部报备，表示自己还在正常营业（服务续约/心跳）。
    *   歇业或搬迁时（服务下线），店铺会通知总部更新信息（服务注销）。
*   **顾客（微服务实例/服务消费者）**：
    *   顾客来到商场，想找某类店铺（比如“特色餐厅”），会先去导购台（Eureka Client 向 Server 查询）获取最新的店铺列表和位置信息（服务发现）。
    *   导购系统可能会告诉顾客有多家符合条件的店铺，并可能推荐人流量较少或评价较高的（结合负载均衡策略）。

如果某个店铺突然关门没通知总部，总部多次联系不上后（心跳超时），也会暂时从导购信息中移除这家店铺，避免顾客白跑一趟。

---

Eureka 体系主要包含两大核心组件：

1.  **Eureka Server (服务注册中心)**：
    *   它是一个独立的服务应用程序，提供服务注册和发现的功能。
    *   **作用**：
        *   **接收服务注册**：接收来自各个服务实例（Eureka Client）的注册请求，并维护一个服务注册表（Registry），记录了所有可用服务实例的元数据（如服务名、IP、端口、健康状况等）。
        *   **提供服务发现**：向 Eureka Client 提供查询服务注册表的能力，使其能够发现其他服务。
        *   **接收心跳**：接收来自服务实例的周期性心跳，以确认服务实例的存活状态。
        *   **服务剔除**：当某个服务实例长时间未发送心跳，Eureka Server 会认为该实例已不可用，并将其从注册表中剔除。
        *   **数据同步**：在集群模式下，Eureka Server 实例之间会相互注册并同步注册表信息，以实现高可用。

2.  **Eureka Client (服务客户端)**：
    *   它是一个嵌入到各个微服务应用中的 Java 客户端库。每个微服务既可以是服务提供者，也可以是服务消费者，因此 Eureka Client 也扮演着双重角色。
    *   **作为服务提供者 (Service Provider)**：
        *   **注册 (Register)**：在应用启动时，将自身实例的信息注册到 Eureka Server。
        *   **续约 (Renew)**：周期性地向 Eureka Server 发送心跳，表明自己仍然可用。默认每30秒一次。
        *   **注销 (Cancel)**：在应用关闭时，向 Eureka Server 发送注销请求，将自身实例从注册表中移除。
    *   **作为服务消费者 (Service Consumer)**：
        *   **获取注册信息 (Fetch Registry)**：启动时从 Eureka Server 拉取全量的服务注册信息，并缓存到本地。之后会定期（默认30秒）从 Eureka Server 拉取增量更新，以保证本地缓存的服务列表是相对较新的。
        *   **服务调用**：当需要调用其他服务时，根据服务名从本地缓存的注册信息中查找目标服务的实例列表，然后通常会配合 Ribbon（客户端负载均衡器）选择一个合适的实例发起请求。

---

> 1.  **服务注册 (Register)**：服务提供者 (Client A) 启动时向 Eureka Server 注册。
> 2.  **心跳 (Heartbeat)**：Client A 定期向 Eureka Server 发送心跳。
> 3.  **获取注册信息 (Fetch Registry)**：服务消费者 (Client B) 从 Eureka Server 获取服务A的实例列表。
> 4.  **服务调用 (Invokes)**：Client B 通过 Ribbon 等负载均衡组件选择一个 Client A 的实例进行调用。
> 5.  **数据同步 (Data Sync)**：在 Eureka Server 集群模式下，各个 Server 节点之间会相互同步注册信息。

Eureka 的典型工作流程可以概括为以下几个关键步骤：

1.  **服务启动与注册 (Application Service Start-up & Register)**：
    *   当一个配置为 Eureka Client 的微服务（比如“订单服务”）启动时，它会通过内嵌的 Eureka Client 组件向配置的 Eureka Server 发送注册请求。请求中包含了自身的服务名、IP地址、端口号、健康检查URL等元数据。
    *   Eureka Server 收到注册请求后，会将这些信息存储在服务注册表中。

2.  **服务续约/心跳 (Renew / Heartbeat)**：
    *   注册成功后，服务实例会周期性地（默认每30秒）向 Eureka Server 发送心跳，以表明自己仍然处于活动状态并且可用。
    *   如果 Eureka Server 在一定时间内（默认90秒，即 `eureka.instance.lease-expiration-duration-in-seconds`）没有收到某个服务实例的心跳，就会认为该实例已失效，并准备将其从服务注册表中剔除。这个过程称为“服务剔除 (Eviction)”。

3.  **获取服务注册信息 (Fetch Registry)**：
    *   服务消费者（比如“用户服务”需要调用“订单服务”）在启动时，其内嵌的 Eureka Client 会向 Eureka Server 拉取一份全量的服务注册信息，并将其缓存在本地内存中。
    *   之后，该客户端会定期（默认每30秒）向 Eureka Server 发送请求，获取自上次拉取以来发生变化的增量注册信息，从而更新本地缓存。这样做可以减少对 Eureka Server 的请求压力，并提高服务发现的效率。

4.  **服务调用 (Service Invocation)**：
    *   当服务消费者需要调用某个服务时，它会先从本地缓存的注册信息中查找该服务名对应的所有可用实例列表。
    *   然后，通常会借助像 Ribbon 这样的客户端负载均衡组件，根据一定的策略（如轮询、随机、响应时间加权等）从实例列表中选择一个具体的实例，并向其发起网络请求。

5.  **服务下线/注销 (Cancel / Shutdown)**：
    *   当服务实例正常关闭或下线时（例如通过 `shutdown` 端点），它会主动向 Eureka Server 发送一个注销 (Cancel) 请求。
    *   Eureka Server 收到请求后，会立即将该实例从服务注册表中移除，这样其他服务就不会再尝试调用这个已经下线的实例。

6.  **自我保护机制 (Self-Preservation Mode)**：
    *   这是 Eureka 的一个重要容错特性。如果在短时间内，Eureka Server 发现大量的服务实例都没有按时发送心跳（比如网络分区故障导致 Server 与大部分 Client 失联），它会进入自我保护模式。
    *   在该模式下，Eureka Server 不会立即剔除这些“失联”的服务实例，而是会保留它们的信息。它认为这可能是网络问题，而不是实例真的都宕机了。这样做是为了避免因为暂时的网络问题导致大量服务被错误地剔除，从而引发更大范围的服务不可用。
    *   当网络恢复后，实例会重新发送心跳，注册信息会得到更新，Eureka Server 也会在情况好转后自动退出自我保护模式。
