# MySQL数据约束

## 什么是MySQL数据约束

MySQL数据约束是数据库系统提供的一种机制，用于确保只有符合业务规则的数据才能被存储。

> 在高并发场景下，数据库层面的约束比应用层检查更可靠。
>
> 另外，我们发现触发器虽然强大，但过度使用会导致业务逻辑分散，增加维护难度。所有业务逻辑都写在存储过程和触发器中，会导致系统难以维护和扩展。建议触发器应该主要用于处理特殊情况，而不是承载核心业务逻辑。
>
> NOT NULL约束的行为会受到SQL模式（SQL_MODE）的影响。在严格模式下，违反非空约束会导致错误；而在非严格模式下，这种约束可能被忽略。因此，在使用约束时，了解数据库的配置也非常重要。
>
> ```sql
> show variables like 'innodb_strict_mode';
> ```
>
> 

## 形象化场景描述

想象一个电子商务平台的订单系统。在这个系统中：
- 每个订单必须有一个唯一的订单号（主键约束）
- 每个订单必须关联到系统中已存在的用户（外键约束）
- 订单金额不能为负数或为空（NOT NULL和CHECK约束）
- 订单创建时间如果未指定，则自动设置为当前时间（DEFAULT约束）

这些约束确保了订单数据的完整性，防止了诸如重复订单、关联到不存在用户的订单、无效金额的订单等问题出现。

## 核心约束类型及其作用

MySQL提供了几种主要的数据约束类型：

1. **主键约束（PRIMARY KEY）**：
   - 确保表中的每一行数据都有唯一标识
   - 不允许为NULL
   - 通常用于表的ID字段

2. **唯一约束（UNIQUE）**：
   - 确保字段中的值不会重复
   - 可以为NULL（但只能有一个NULL）
   - 适用于用户名、邮箱等需要唯一性的字段

3. **外键约束（FOREIGN KEY）**：
   - 建立表与表之间的关系
   - 确保引用的值在被引用表中存在
   - 维护数据的引用完整性

4. **非空约束（NOT NULL）**：
   - 确保字段不能为NULL值
   - 适用于必须提供值的字段

5. **默认值约束（DEFAULT）**：
   - 当插入数据时未指定该字段的值，则使用默认值
   - 常用于时间戳、状态标志等字段

6. **触发器（TRIGGER）**：
   - 在特定操作（INSERT、UPDATE、DELETE）时自动执行的存储过程
   - 可用于复杂的数据验证逻辑

## 工作流程

MySQL数据约束的工作流程如下：

1. **定义阶段**：在CREATE TABLE或ALTER TABLE语句中定义约束
2. **验证阶段**：当执行INSERT、UPDATE或DELETE操作时，MySQL会检查数据是否符合约束条件
3. **结果处理**：
   - 如果数据符合约束条件，操作成功执行
   - 如果数据违反约束条件，MySQL会拒绝该操作并返回错误信息

## 示例图解

```
+-------------------+        +-------------------+
|     订单表         |        |     用户表         |
+-------------------+        +-------------------+
| 订单ID (PK)       |        | 用户ID (PK)       |
| 用户ID (FK) ------+------> | 用户名 (UNIQUE)   |
| 金额 (NOT NULL)   |        | 邮箱 (UNIQUE)     |
| 创建时间 (DEFAULT) |        | 注册时间           |
+-------------------+        +-------------------+
```

## 实际经验分享

在我之前参与的一个金融交易系统项目中，数据约束起到了至关重要的作用。我们为交易表设置了严格的约束：

- 交易ID作为主键，确保每笔交易唯一
- 账户ID设为外键，关联到账户表，确保交易只能发生在有效账户上
- 交易金额设为NOT NULL，并通过触发器检查余额是否充足
- 交易时间设默认值为当前时间戳

