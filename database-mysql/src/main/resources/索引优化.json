["各位同学，大家好啊", "这一个小节我们来介绍", "MYSQL 的 server 层是如何决定使用哪条索引的", "如果我们的索引需要强制走", "或者是重新分析的话", "需要怎么做", "好，我们开始", "第一， mysql server 是如何决定走哪条索引的啊", "他在选取索引的时候", "会参考一个索引的基数", "英文叫 CARDINALITY ", "也可以叫索引的区分度", "这个基数是 MYSQL 估算的", "反映这个字段有多少种取值", "什么意思呢", "比如说我有一张大表是全校所有同学的情况", "那全校所有同学的情况", "有个字段叫做班级", "我如果以班级做了一条索引的话", "那么请问这个班级这个字段有多少种可能的取值呢", "那大概就是我们全校的班级的个数，对吧", "我们全校比如说有100个班", "那这个字段可能就有100种取值", "那100这个数就是索引的基数啊", "就叫这个 CARDENNALITY ", "但是问题是这个数它是不精确的", "因为如果一个表有几百万行的话", "MYSQL 没有空去精确的计算", "这个索引上的字段有多少种取值", "它是估算的", "怎么估算", "它会选取几个页", "也就是几个 B 加数的什么叶子节点", "几个配置", "把它取出来", "里边不是有什么数据吗", "对吧", "选几个页取出数据", "查看一下这几个页里面有多少种取值", "再乘以页的数量", "也就是说它是一种抽样计算的方法", "就是这个基数了", "我们为了看一下啊", "MYSQL 它抽样计算算的怎么样呢", "我们可以做一个应用", "我们使用以下的 SQL 语句建表挺复杂啊", "它其实一点都不复杂", "首先第一行， create table ", "我们建一个表叫什么", "这个表就一个字段叫 c ct ", "ct 1", "然后后面数据表建好之后，我们干嘛", "12345", "把 city 这个老表啊", "就是这个 demo 里边的这个表的 city 的这个值", "五次复制进去", "也就是说我们现在这个表有五倍的这个 city ", "就是原表里面的这个值", "好，我们现在试一下", "首先呢是建表对吧", "建这个 T 1这个表只有一个字段啊", "这个字段建好了啊", "这个表只有一个字段", "我们可以 DISCCB 下 DSC ", "这个表只有一个啊", "ct 这个字段", "然后五次将老表 city 这个表的 ct 值", "存入这个 CC 1这个新表啊", "有同学问这要干嘛呀", "后边有用啊", "这样存一次啊", "存两次、存三次、四次、五次", "那么现在啊，这个新表是长什么样的", "它只有一列", "是城市名这个列", "而且它的数据量是原来这个表的五倍", "咱们看一下", "看嘛，它的容量是原来的五倍", "有3000行", "原来只有600行", "好，我们再进行一个操作", "我把 PPT 里最后一个语句啊粘贴过来", "再看这是要干嘛", "把 CT 1的这个字段啊，更新一下", "怎么更新", "从老表里面选取这个 city ", "但是是随机选的", "什么意思啊", "就是把这3000行的这个城市名都打乱", "它本质上是这个意思啊", "把这3000行的城市名都打乱存放", "这样的话让它没有规律啊", "我们后面可以继续做实验啊", "好，我们再看一下他是不是打乱没有规律了", "再看，我再查询一下", "已经完全打乱没有规律了", "好", "那我要干什么呢", "增加以下前缀索引", "看到没有", "我要用唯一的这个列啊", "做一个索引", "这个索引呢，我要做八个", "我不使用 city 这个列做索引", "而是用 city 的前缀", "所以它的第一个字符", "这个是 ct 的前两个字符做的", "这个是 ct 的前三个字符做索引", "以此类推啊", "我们把这几个索引都建一下", "首先是第一个", "以 city 的第一个字符做索引", "好，建完了", "然后是二、二、前缀索引", "然后是三前缀索引", "然后是四前缀索引", "然后是五", "五、的建重啊，没事", "七、把好，这所有的这个前缀索引都建完了", "我们用一个语句", "我们干嘛呢", "上一小节用过", "我们用 show index 查看一下这些索引的情况", "我先缩小一下", "这个表比较大", "再缩小一下", "好，我放大看啊", "这有一堆什么索引", "一堆索引的 column name 都是 city ", "好，大家看", "注意看到这是什么吗", "这是啊， CARDINALITY ", "就是我们今天所说的基数", "也就是说这是 MYSQL 的 server 层去估算的", "这个索引它有多大的区分度", "在这个索引上我有多少取值", "首先，如果是以首字母做索引的话", "这个索引的键有26种可能性", "大家一看就明白怎么回事啊", "他就是以城市名的首字母做索引", "那首字母只有26种可能", "因为首字母都大写吗", "首字母只有26种可能", "也就是说这个索引的区分度是26", "它相当于把我们所有的数据", "切成了26个可能性", "那我们去啊", "按照城市这个查询条件去查询的时候", "它的区分度大概就是这样", "它可以以1/26的可能性去切开这个数据", "那如果我们是以这个城市名的前两个字符", "作为索引字段的话", "它有188种可能性", "也就是说他把我们的数据切成了188种可能", "这样的话，我们以城市名作为条件去查询的时候", "是不是它的力度会分得更细", "它分开之后", "我们去扫描所有行的数量是不是会更少", "像前面这种", "如果是以城市名的第一个字母作为索引值的话", "我们搜索啊", "他会把比如说我想搜索这个一个以 C 开头的城市", "那他会把所有以 C 开头的城市的都给你列出来", "然后我们的 server 层要一个一个的去干嘛呀", "去扫描，一个个去对比", "它是不是我们所要的那个城市", "如果是以城市名字的头两个字符作为索引呢", "它所扫描一个个对比的工作量", "是不是减得更小了", "那我们看以投一个字符它的区分度", "它的基数是26", "投三个是455", "投两个字符188", "投四个是559", "再往下，再往下", "以前七个或者是前八个", "作为这个索引字段的情况下啊", "他的这个收效是不是很低了", "所以说我们在这里可以看到", "用前三个或者前四个字符作为什么前缀索引", "其实它的作用就体现得非常好了", "而且它占用磁盘空间小", "因为大家也知道一条辅助索引就是一个小表", "就是一个 B 加数", "好，我们回来啊", "我们刚才做了什么呢", "是用收 index 这个命令查看了各个索引的基数", "结果发现什么呀", "前一个前缀它的区分度很小", "但是前两个前三个字符作为前缀", "它的区分度就很大了", "所以说 MYSQL 在选择索引的时候", "它会首先考虑你的索引的什么区分度", "如果你的区分度越大", "这个地方你搜索同样的字段", "它会越可能选用这条索引", "也就是说，如果我们有时候看啊", "为什么我们同样的一个 SQL 语句啊", "他走了这条索引而没走另一条", "很可能是因为他觉得这条索引的区分度更大", "但是有个问题", "这个索引的区分度是不是永远估计的准确", "不是，大家也知道", "它是通过几个 year 去抽样估计的区分度", "所以如果他估计的区分度不对怎么办", "我们就可以强制使用索引", "强制使用索引", "大家有些同学可能用过啊", "就是在 SQL 语句后面加上 false index ", "后面加索引名", "用这个 for index", "可以使 MYSQL 强制的使用某条", "你认为更为高效的索引", "为什么他认为这个不高效", "是因为他在 CODALITY 区分度的估计上出了问题", "好，有同学说了", "它的区分度估计出了问题", "我也不想使用强制索引", "能不能让它重新估计呢", "是可以的啊", "这个叫索引的优化啊", "我们使用一条 SQL 语句叫 analyze table ", "那个表叫 city 1对吧", "我们可以 analyze table T 1", "这个 SQL 语句就可以重新统计索引的信息", "那重新统计的时候呢", "也会重新计算所有的基数", "这个语句啊，特别适合那种索引基数估计明显失误", "而导致索引选取有问题的情况啊", "你可以使用 analyze table 来重新估计", "好吧", "我们总结一下这个小节的内容", "首先，根据索引的基数", "可以判断索引性能的好坏", "这是我们人去判断的", "你可以查一下这个索引估计出来的基数是多少", "你建一条索引", "它尽量的大", "它这条索引的性能才会好", "但是有没有可能出现 MYSQL 自己估计的有问题", "所以呢，是有可能的", "他走了别的", "这种情况下有两个解决的方案", "第一个是用 force index 强制使用某条", "你认为效率更高的索引", "或者用 analysis table 让它重新统计索引的基数信息", "好，谢谢大家", "5-3"]