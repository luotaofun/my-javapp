["接下来我们来看一种新的锁", "它叫做公平锁与非公平锁", "说到公平与非公平啊", "这里这个法官用的法锤还是", "但是呢，看到这个我就有点慌", "我不太确定", "还是叫什么名字", "为什么呢", "然后啊，他这个", "因为我老婆是个律师", "我辩论或者说这个争论吵架吵不过他", "然后呢，也不敢怎么样", "嗯，要是说的他不高兴了", "那离婚的时候我净身出户", "因为他掌握婚姻法的种种", "这个有利于他的手段嘛", "所以，所以说我这个家庭地位啊，岌岌可危", "那么也是开个玩笑啊", "也是活跃一下我们课堂的气氛", "大家不要当真", "我们现在啊，还是主要来看一下", "在公平锁和非公平锁这个小节中", "首先我们会讲啊", "我们有哪些内容", "什么是公平", "第二就是说", "什么是非公平", "世界肯定是公平比较好嘛", "但是为什么在我们程序中", "主流也是这么认为的", "这个技术人的天堂中还设置非公平呢", "他有原因的", "我们第二点就是来分析这个原因", "然后呢，我们会以公平所举例", "然后呢，我们会写一个代码案例来把我们啊", "再去以非公平所举例", "这个公平和非公平所带来的那个差异", "小伙伴们通过这个第五个", "一下子就可以体现出来", "就可以对这件事情理解的非常深刻了", "这个代码案例啊", "然后呢，我们是第六个会讲几个特例", "它是不遵守公平和非公平的", "有几个特例呢", "最后呢，我们会对比一下公平和非公平各自的优缺点", "并且在第八个小部分中", "我们对于公平和非公平是如何实现的", "对它进行一下源码分析", "以上就是我们关于公平和非公平的内容", "那么，首先我们来看一下什么是公平和非公平", "它指的是按照我们线程请求的顺序来分配。所", "对于公平而言", "你先来，唉，我就给你先分配所", "很公平也很好理解", "不是说完全乱序", "但是这里的非公平指的是呢", "这里啊，大家一定要注意清楚这个非公平啊", "不是说我既然不公平", "我就随机好了", "我就特别不公平", "他这个非公平指的是", "不是这个意思", "我不完全按照请求的顺序", "他才可以插队的", "只有在一定的情况下", "就是说我们这里的非公平啊", "我们就这里有个注意点", "同样，他其实内心还是一个好人", "他是不提倡插队的", "只是在合适的时机，哎", "他这里的非公平呢", "它允许插队", "那么好，小伙伴们肯定会有一个疑问了哦", "不是说盲目乱插队", "是，那你说合适的时机插队", "什么叫做合适的时机呢", "那这个合适的时机", "那我被插队了", "你说合适就合适啊", "那你说以谁说的为准呢", "我说不合适", "我不高兴", "所以说呀", "我们要举一个例子", "在这里呀", "我们举一个买火车票被插队的例子", "就可以说明这个公平和非公平", "用这个例子呢", "他们的情况", "第一个，假设我们以前这个还没有12306", "网上 APP 的时候", "大家还是说排队去火车站买", "其实12306也没几年嘛", "那个时候是这样的", "那么我们那个时候呢", "那个可是很难抢票的", "尤其是春运的时候啊", "买火车票", "这个时候一个插队", "那简直是影响到我能不能买到票啊", "好，这个时候呢", "所以是非常关键的", "假设有这么一个情况", "在我，我们是排在队伍的第二位", "有一个人他是先于我们排队", "然后在我们前面呢", "所以他自然是先于我们买票", "然后他买完了票走了", "可是因为我经过了彻夜的那个排队啊", "下一个本来是我", "实际上要彻夜排队的，提早去的", "因为那个时候买火车票", "所以那个时候其实我脑袋还是嗡嗡作响", "要不然你买不到", "还不是特别清醒", "确实该轮到我了", "我也没有一下子缓过神来", "可是呢，这个时候呢", "这个时候第一个人本来已经走了", "就在那愣住了", "他突然回来又问了一下乘务员说", "我就问一句", "唉，请问那个火车几点发车", "很快的", "那你说这个叫不叫插队", "就这样问一句", "这个实际上就是完全模拟了", "我们在线程中插队的情况", "我们来想一下", "体现了第一", "这种情况下主要是体现了什么呢", "由于我啊，从那个呆萌的状态到缓过神来去执行", "这个就对应到我们线程从阻塞状态被唤醒", "这个是需要一个长时间切换的", "而刚才那个人他呢", "是很清醒的", "问好之后他就走", "他直接来问", "其实并没有影响到我们什么东西", "我也是脑子不清楚", "因为那个时候就算他不来问", "这个就是反映了我们这边非公平的意思", "也没办法买票", "我们来看一下为什么要有非公平", "小伙伴们千万不要生气啊", "说自己被买票的时候、排队的时候", "为什么你默认还是非公平", "挂号的时候被插队", "在我们在这边的锁里面", "那难道我前面排队就白排了吗", "默认策略就是非公平的", "java 设计者，你是不是没有素质啊", "其实不是这样的", "我们通过刚才那个买票的例子也分析出来了", "为什么呢", "这样做可以提高效率", "它最主要是避免了唤醒带来的空挡期呀", "这里有一个空档期的", "因为我们为什么不希望锁都是公平的呢", "毕竟公平是一种好的行为", "但是啊，我们如果始终公平的话", "对不对", "不公平是不好的", "那么他再把那个已经挂起的线程恢复过来的", "这段时间是有开销的", "而这段时间如果你是公平的话", "那么这段时间谁都拿不到锁", "你要求必须排队的话", "谁都没办法处理", "我们是可以允许非公平的", "但是我们假设呀", "好，我们假设我们这边有三个线程", "第一个线程 A 持有这把锁", "线程 B 呢，请求这把锁", "由于这个锁已经被 A 持有了", "好", "那么 B 自然而然要去休息", "那么 B 呢，就要被唤醒", "假设 A 这个时候释放了", "对不对", "并且拿到这把锁", "突然 C 来请求这个锁", "假设与此同时", "那么由于 C 这个线程啊", "它本身一直是处于唤醒状态", "它是可以立刻执行的", "他也没有休息", "那么它很有可能就在 B 被完全唤醒之前", "就已经获得了", "并且又释放掉这种锁了", "并且使用完了", "这就形成了一种双赢的局面", "C 肯定是赢了", "第一个，谁赢了", "为什么叫双赢呢", "他拿到锁了", "C 没有排队", "其实 B 也没有输", "第二个，谁赢了", "并且用完了释放了", "B 本身这段时间他知道说 A 已经释放了", "唤醒币的这个过程是耗时的", "为什么呢", "然后呢，唤醒币", "那么这段时间呢", "本身这段时间我既然耗时", "不如就让给别人", "我也拿不到锁", "他拿到锁的时间并没有推迟", "所以说对于 B 而言", "所以这是一种双赢的局面", "是可以带来吞吐量的提升的", "这种插队呢", "说到这里，小伙伴们一定明白了啊", "为什么说要有非公平锁", "主要就是因为啊", "由于这个唤醒的过程", "在我们大多数的情况下", "这个开销其实是比较大的", "他为了增加我们的吞吐量", "那在这个期间", "来把这个期间呢也给利用出去", "这就是我们非公平设计的最根本的原因", "说到这个唤醒啊", "我又想到了一个例子", "以前的女神呢", "换男朋友有空档期", "她换男朋友对吧", "在这个空档期的过程中啊", "为什么备胎补上啊", "备胎来补上", "因为备胎随叫随到", "没有很高的唤醒成本", "就像是里面这个切换的成本一样", "而男朋友呢", "也很慎重", "那么唤醒呢，也是有很大成本的", "不过我必须声明啊", "所以这样一来就提高了效率", "并且实际上我反对这种行为", "我并不赞同啊", "只是方便大家理解", "我举这个例子呢", "不代表爱情观", "符合自己的美满的爱情", "也希望大家呢，都能找到", "下面啊，我们来说一下公平的情况", "我们以 reaction lock 为例啊", "这个锁本身它默认是非公平锁", "看一下公平的情况", "但是你可以在创建它的时候呢", "诶，给它设置为公平锁", "你只要填一个参数就可以了", "我们来举个例子", "好", "一、二、三、四，他们是按顺序调用我们的 lock 的", "假设呢，我们有四个线程", "你按顺序吗", "就像这幅图一样", "那么会怎么样", "好，第一个线程拿到", "他们是进入到一个等待队列中开始排队", "然后呢，二、三、四就在这排队", "然后呢，等第一个执行完了之后", "释放完之后啊", "它就释放了", "因为为什么给第二个", "对不对", "就拿到了", "第二个，哎", "因为第二个是最先进来排队的", "于是呢，就给第二个", "那他等待的时间最长", "剩下的呢，依然在里面排队", "然后呢，二弄完之后还是三", "这个是非常明显的公平的情况", "然后呢，就是四", "可是假设我们不公平了", "假设是不公平", "这情况就有变了", "一释放的时候", "好", "正好他也想拿到这把锁", "突然线程五来了", "这是不是就符合我们刚才插队的情况啊", "这个插队就是说有任何一个其他的线程", "排队的那个买票的", "不要求是刚才走的那个一号的", "不要求是他就是只要在我是2号位，对不对", "因为我唤醒需要时间", "等着我买票", "都想去获得这把锁", "只要在这个期间有任何一个线程", "我假定你插队并且时间很短就能结束", "由于你们本身是清醒的", "所以呢，线程五过来了", "好的", "他正好呢去执行这个 lock ", "发现现在并没有线程持有这把锁", "我们的这个 reaction log", "这个时候啊", "因为我啊，我是2号位", "我还没来得及获取呢", "我为了提高效率", "那么很好嘛", "获取需要时间", "你直接拿到这把锁", "我就让五来插队", "这就是一种插队的不公平现象", "这也是我们默认的策略", "二、本身还在排队", "反映到图中呢，就是这样的", "一、一旦解锁", "五、直接可以拿到这把锁", "与此同时，五来加锁", "下面啊，我们用一个代码来演示", "这个代码可以把我们非公平和公平", "给表现出来", "这个现象呢", "好，打开代码编辑器", "因为我们如果只停留在刚才那个理论啊", "你说了这么多", "那我知道小伙伴们大呼不过瘾", "不给我点代码看看肯定不行", "好，我们来新建一个类", "这个类就叫做 FIRELOCK ", "演示公平锁的情况", "它不仅演示公平锁", "所以它是演示公平和不公平两种情况", "还能演示不公平", "可以看到呢，它们的差异是很大的", "这个类啊，我们要做的就是说打印", "打印这件事情本身是耗时的", "打印一些东西", "所以它就容易出现排队的情况", "对不对", "那么我们来新建一个类", "在这个里面呢", "它是一个打印的队列", "你要是想打印", "在这个里面", "我们去打印", "我们打印机只有一台", "那你肯定要先拿到锁", "所以说我们在这定义一把锁", "它就叫做 q lock ", "q lock 队列锁专门用来锁住这个队列的", "在这里呢，会传入参数", "你看一下啊", "这里的参数啊", "前面也提示出来了", "这里的参数你传 true ", "fair ， fair 就是公平还是不公平", "true 和 false 就代表公平还是不公平", "在这种情况下呢", "那我们先来看一种公平的情况", "我们把这个类还有几个方法给完善一下", "这个方法就是打印嘛", "就叫做 print job ", "在这个方法里面", "这个文件就是将要被打印的", "我们会传入一个文件", "然后我们就要打印了", "好的", "打印之前必须获取锁呀", "所以我们来获取它", "哎，小伙伴们都知道我要说什么了", "获取完之后", "获取完之后你先别打印哎", "先去把锁给我释放了", "对，没错", "在这里呢，写出 try 和 finally ", "我们每一次都遵守这样的规范", "好，释放完之后我们再去做中间的事情", "在这个里面呢，我们会打印东西", "我们只模拟一下所需要花费的时长", "那打印东西啊", "这个时长呢", "我们用一个随机数就可以了", "然后呢，把这个它生成的是 double ", "这是我们生成的一个时间", "把它转成 long ", "好，有了这个时间之后", "我们来打印一个提示啊", "这个提示是说正在打印需要几秒", "这个几秒就是我们这个 duration ", "duration 除以1000就是秒数", "所以我们就用它去除以1000", "那谁在打印呢", "你得把这个线程名字给打出来", "所以拿到我们县城的名字", "那么你说你需要这么长时间", "好", "我们就让线程去等待", "OK 啊", "你是正在打印的场景", "这么长时间去模拟呢", "这个就是一个完整的打印", "但是我们为了掩饰我们公平和不公平", "就好比说我们一次打印呢", "我们让这件事情打印两次", "可能是要打印两张纸", "那么我们在这里再复制一遍", "这也是有可能的", "好，代码提示，代码重复", "那这个是我们故意的", "就是说我们一次打印啊，会打印两次", "比如说就是有这个需求嘛", "比如说我这个需求就是我同一个文档", "一个给我自己看", "我要打印两份", "那每一次我肯定是要打印同样的东西", "那打印两份", "一个给老师看", "所以我就把这个给复制一下", "这就是我们的业务场景", "我们写一下 main 函数", "好，在这种情况下呢", "main 函数里面", "首先要把我们这个打印队列给建出来", "然后就派十个线程去打印", "我们把这十个线程写成一个数组的形式", "你才能看出来他这个是有争抢的", "因为只有数量多了", "这样就不用加 static 修饰", "好，我们把这个类放到外面去", "它就可以调用到", "我们再来继续写这个线程", "都给启动起来", "我们把这十个线程啊", "拿到它的序号之后", "那么很简单", "初始化", "在他的 RUNNABLE 里面", "那这个 RUNNABLE 呢，我们还是要写一个新的类", "要写一个 RUNNABLE ", "他所做的事情啊", "就是调用我们的打印队列去打印", "好", "实现了 RUNNABLE 接口之后要重写 run 方法", "在 run 方法里面先给个提示", "说我们是第几个线程开始打印", "然后呢，你既然开始打印了", "你就去调用我们 print ", "那么很好啊", "所以他还要传入一个 print cu ", "Q 的 print job 方法", "在构造方法中传入", "就可以创建它的构造方法", "好，这样把它拿到", "然后呢，去打印这个 document 是无所谓的", "因为我们在打印的时候", "实际上是随机去让它休息的", "然后打印完呢", "为什么要说在这个已经有打印队列的基础上", "同样要给出一个提示", "还弄一个我们的这个提示呢", "这是因为啊，我们这一个打印实际上是两次", "因为它是两个独立的", "所以呢，我们一个人去开始打印之后", "它需要打印两次才能打印出，打印完毕", "所以这才是我们能显示出公平和不公平的关键", "所以在这里呢，我们就继续去补充我们的 main 函数", "在 main 函数中写一个我们的 job ", "job 里面呢，就传入我们的 print q ", "print q 刚才已经建好了", "OK ，这样一来他就写完了", "然后我们再把它给启动起来就可以了", "为了让他们启动啊", "有顺序性", "因为你启动如果太密集的话", "为什么说有顺序性", "它们是有可能发生顺序错乱的", "但是我们如果让他稍稍休息", "它就不会顺序错乱了", "所以呢，我们就在这里给它休息100 ms ", "休息100 ms 是足够了", "看一下效果", "我们来运行这个程序", "再次运行", "多打了一个大括号啊", "好，可以看出呢，他这边时间有点问题", "由我们来修正一下", "我们把这个打印的时间啊，简化一下", "让它产生1~10的随机数", "我们可以用我们的 random 来实现", "他最小就是一了", "区间写十，然后再加一", "好 duration 类型要改一下", "这样也不用除以1000", "ok ", "那这里时间变成了很小的数字", "变成对应的秒数", "我们就把它再乘以1000", "我们把两处的时间都改一下", "好，这样我们就可以运行我们的程序了", "运行程序我们看一下效果啊", "由于我们是按照顺序去启动线程的", "在这里呢，我们看", "是零，123456789", "所以啊，在这里呢", "然后呢，他们会进入到这个 run 方法里面", "都会打印出自己开始打印", "但是由于啊，自己拿不到这个 print job 这把锁", "这把锁只有第一个人可以拿到吗", "那么我们看一下在这里他怎么等的呢", "所以他就会开始等", "然后呢，线程零结束了之后", "线程零，它需要八秒", "线程一、线程二、线程三", "他们是按照顺序的", "我们看123456789", "然后又是零", "然后呢，还有", "我们看下一个还是一", "然后呢，等七秒", "零就打印完毕了", "但是零打印两次之后", "所以零会打印出这边打印完毕", "然后呢，一也打印完毕", "然后呢，一能拿到这把锁", "同样二", "这个打印完毕代表它已经打印完两次了", "然后三它是完全按照顺序的", "我们看一下它实际上执行的时候是怎么样的呢", "就是说线程零啊", "剩下的那边的线程123456789", "然后呢", "进来之后他拿到锁", "并且逐步拿到这把锁", "他们逐步被启动", "所以他们逐步进入了等待队列", "应该是123456789", "他们都拿不到", "所以现在在等待队列里面的", "然后呢，等到线程零执行完了这里之后", "他去释放", "他想再拿", "释放完之后呢", "由于是公平锁", "可是这个时候他再拿", "于是他会怎么样啊", "公平所发现队列里面已经有了", "零呢，就会排在刚才九的后面", "所以这个时候呢", "他会让他去排队", "因为现在队列里已经有人了", "所以123456789", "是123456789", "所以呢，我们打印的时候也是这样的", "后面就是零", "然后呢，是123456789打印", "零先打印", "然后再是零", "然后又是123456789", "因为零已经排到第二个轮回了", "这个顺序我们加一个提示啊", "非常的整齐", "这里加一个秒", "可以看出呢，这个就是非常公平的情况", "那么我们现在再来看一下不公平会怎么样", "公平和不公平吗", "大家还记得在哪里去改变它", "在这里的构造函数中", "应该是在这里", "让我们来先模拟一下", "我们如果传入 false ", "我们先用大脑思考一下", "如果是这种情况会怎么样", "如果我们传入 false 非公平情况呀", "什么叫非公平呢", "我们已经看过 PPT 了", "假设我释放的时候有新人来拿", "而我在队列里面的这个还没有被唤醒的", "人家是可以拿走的", "在这里哪里会出现这个情况啊", "所以说我们来看一下", "我们的线程零先进来，对吧", "就是在这里", "然后释放锁", "他拿到锁", "线程零先进来", "也就是在它打印的这段期间", "在它释放锁之前", "这还是一样的", "排队已经排满了", "然后呢，县城零又想拿锁", "123456789都排在后面", "这个时候是一个非常典型的场景", "线程零又想拿锁的时候", "其实线程一它在队列里已经等待了", "但是由于你在队列里等待你唤醒", "优先把这个锁交给我们的线程零", "所以我们的锁呀", "你需要时间", "因为线程零呢，还没有陷入到阻塞状态", "它也不需要切换", "所以说这个时候线程零打印完一遍", "所以呢就把这个锁给它", "又打印第二遍", "哎，线程零直接两次任务两份一起打完了", "我们看一下实际是不是这样", "这是我们的推测", "我们来执行我们的程序", "在这里，线程零开始打印需要四秒", "好，我们看一下", "四秒钟之后又是线程零", "看到没有，需要三秒", "然后呢，线程一开始打印需要九秒", "大家记得他这个时候说开始打印", "线程一一共需要打印两份东西啊", "它还没有真正打印", "这个时候才是打印第一份", "因为他没有拿到锁", "两份都打完了", "然后这个时候呢，是打印第二份", "然后呢，你看二打印一份", "然后他说打印完毕", "看到没有", "再打印第二份", "刚才我们把这个锁给修改成公平的", "我们现在来对比一下", "好，把它停掉", "我们记住，现在呢", "我们一对比就知道了", "他是一个人连续打印两份", "再打印一份", "打印一份，唉", "你看", "连续打印两份", "打印一份，再打印一份", "它就是一人一份，一人一份", "但是如果我们改成公平的", "运行零需要八秒", "我们看啊", "四也是的", "然后呢，零打印完不是零了", "你看", "一打印完呢变成二", "零打印完变成一了", "我们再来看下一个，对", "而是说一个一个来", "他不是说一个人拿两份", "这就是掩饰了公平锁和非公平所带来的差异", "我们如果调整了这边的参数", "就会给这个排队的策略", "带来很大的影响", "以及拿手的策略", "回到我们的 PPT ", "以上呢，就是我们演示了这个公平锁和非公平锁的效果", "下面啊，再让我们来看一个特例", "生活中有的人是有特权的", "在我们这个所中呢，就叫做 TRILOCK ", "有的人非常厉害", "它本身非常厉害", "也就是说", "它不遵守我们设定的公平原则", "一旦有线程释放了锁", "如果我们在 try lock 的时候", "即便呢，在他之前已经有人在等待队列里面了", "那么他就能拿到", "即便呢，我们设置了它是公平的", "但是他这个方法是可以不遵守公平的", "也就是说， try lock 本身自然是带着插队属性的", "下面我们来对比一下公平锁和非公平锁", "好", "它们各自的优缺点", "每个县城公平平等", "对于公平所而言", "每个县城等待一段时间后呢", "但是它也有缺点", "总有执行的机会", "在唤醒的那段期间呢", "因为它吞吐量小了", "所以它速度要慢一些", "被浪费了", "它自然它的优势就是速度快、吞吐量大", "对于不公平所而言啊", "但是有可能带来一个线程饥饿的问题", "也就是说，每次我释放", "他非常郁闷", "总有人来抢", "这个就叫做使饥饿", "他在很长的一段时间内得不到执行", "所以呢，这是它们的优缺点对比", "我们再来分析一下源码", "我们看到这里", "从源码的角度来看啊", "实际上是公平所获取的一个过程", "其他的部分呢，我们先忽略", "主要看这个红色的框", "在这里他会去判断", "是不是前面有人在队列中已经开始排队了", "如果说没有的话", "而非公平锁呢", "唉，我再去获取", "其他是差不多的", "他根本就没有这个判断", "也就是说他不管你现在有没有人在队列中", "我们看他没有这个判断", "我都尝试去获取", "这就是公平锁和非公平锁", "这一点小的差异带来了他们强所规则的变化", "在强所的时候", "5-10 是否允许一部分人“先富起来”", "5-11 代码演示：先来后到的特例、优劣、源码分析"]